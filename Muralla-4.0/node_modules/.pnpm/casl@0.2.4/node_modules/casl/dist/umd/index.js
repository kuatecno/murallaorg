!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(n.casl={})}(this,function(n){"use strict";function t(n,t){for(var e={},r=0;r<n.length;r++){var o=n[r];if(o.conditions){var i=o.inverted?"$and":"$or";e[i]=e[i]||[],e[i].push(t(o))}}return e}function e(n){return n.inverted?{$nor:[n.conditions]}:n.conditions}function r(n){return n.exec=function(){return Promise.resolve("findOne"===n.op?null:[])},n}function o(n){return t(n,e)}function i(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"read",e=n.rulesFor(t,this.model||this);return e.length?this.find(o(e)):r(this.find())}function u(n){Error.call(this),this.message=n,this.constructor=u,"function"==typeof Error.captureStackTrace?(this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor)):this.stack=new Error(this.message).stack}function c(n){if(!n||"string"==typeof n)return n;var t="object"===(void 0===n?"undefined":l(n))?n.constructor:n;return t.modelName||t.name}function f(n){return JSON.parse(JSON.stringify(n))}function a(n){return"string"==typeof n||Array.isArray(n)&&n.length>0}u.prototype=Object.create(Error.prototype);var s=function(n){return n&&n.__esModule?n.default:n}(function(n,t){return t={exports:{}},n(t,t.exports),t.exports}(function(n,t){!function(){function e(n){return"function"==typeof n}function r(n){return"[object Array]"===Object.prototype.toString.call(n)}function o(n){return n instanceof Date?n.getTime():n instanceof Array?n.map(o):n}function i(n,t){return n.get?n.get(t):n[t]}function u(n){return function(t,e){if(!r(e)||!e.length)return n(t,e);for(var o=0,u=e.length;o<u;o++)if(n(t,i(e,o)))return!0;return!1}}function c(n,t){return n.v(n.a,t)}function f(n,t){for(var e=0;e<n.length;e++)if(c(t,i(n,e)))return e;return-1}function a(n,t){return{a:n,v:t}}function s(n,t){var e=[];return l(t,n.k,0,e),1===e.length?c(n.nv,e[0]):!!~f(e,n.nv)}function l(n,t,e,o){if(e!==t.length&&void 0!=n){var u=i(t,e);if(r(n)&&isNaN(Number(u)))for(var c=0,f=n.length;c<f;c++)l(i(n,c),t,e,o);else l(i(n,u),t,e+1,o)}else o.push(n)}function h(n,t){return{a:{k:n,nv:t},v:s}}function d(n){return"Object"===String(n.constructor)||"functionObject(){[nativecode]}"===String(n.constructor).replace(/[\r\n\s\t]/g,"")}function y(n){(n=o(n))&&d(n)||(n={$eq:n});var t=[];for(var e in n){var r=n[e];if("$options"!==e)if(g[e])b[e]&&(r=b[e](r,n)),t.push(a(o(r),g[e]));else{if(36===e.charCodeAt(0))throw new Error("Unknown operation "+e);t.push(h(e.split("."),y(r)))}}return 1===t.length?t[0]:a(t,g.$and)}function p(n,t){var e=y(n);return t&&(e={a:e,v:function(n,e){return c(n,t(e))}}),e}function v(n,t,r){function o(n){return c(i,n)}e(t)&&(r=t,t=void 0);var i=p(n,r);return t?t.filter(o):o}var g={$eq:u(function(n,t){return n(t)}),$ne:function(n){return function(t,e){if(!r(e)||!e.length)return n(t,e);for(var o=0,u=e.length;o<u;o++)if(!n(t,i(e,o)))return!1;return!0}}(function(n,t){return!n(t)}),$or:function(n,t){for(var e=0,r=n.length;e<r;e++)if(c(i(n,e),t))return!0;return!1},$gt:u(function(n,t){return v.compare(o(t),n)>0}),$gte:u(function(n,t){return v.compare(o(t),n)>=0}),$lt:u(function(n,t){return v.compare(o(t),n)<0}),$lte:u(function(n,t){return v.compare(o(t),n)<=0}),$mod:u(function(n,t){return t%n[0]==n[1]}),$in:function(n,t){if(!(t instanceof Array)){var e=o(t);if(e===t&&"object"==typeof t)for(u=n.length;u--;)if(String(n[u])===String(t)&&"[object Object]"!==String(t))return!0;if(void 0===e)for(u=n.length;u--;)if(null==n[u])return!0;for(u=n.length;u--;){var r=c(p(i(n,u),void 0),t);if(r&&"[object Object]"!==String(r)&&"[object Object]"!==String(t))return!0}return Boolean(!!~n.indexOf(o(t)))}for(var u=t.length;u--;)if(~n.indexOf(o(i(t,u))))return!0;return!1},$nin:function(n,t){return!g.$in(n,t)},$not:function(n,t){return!c(n,t)},$type:function(n,t){return void 0!=t&&(t instanceof n||t.constructor==n)},$all:function(n,t){return g.$and(n,t)},$size:function(n,t){return!!t&&n===t.length},$nor:function(n,t){for(var e=0,r=n.length;e<r;e++)if(c(i(n,e),t))return!1;return!0},$and:function(n,t){for(var e=0,r=n.length;e<r;e++)if(!c(i(n,e),t))return!1;return!0},$regex:u(function(n,t){return"string"==typeof t&&n.test(t)}),$where:function(n,t){return n.call(t,t)},$elemMatch:function(n,t){return r(t)?!!~f(t,n):c(n,t)},$exists:function(n,t){return void 0!=t===n}},b={$eq:function(n){return n instanceof RegExp?function(t){return"string"==typeof t&&n.test(t)}:n instanceof Function?n:r(n)&&!n.length?function(n){return r(n)&&!n.length}:null===n?function(n){return null==n}:function(t){return 0===v.compare(o(t),n)}},$ne:function(n){return b.$eq(n)},$and:function(n){return n.map(y)},$all:function(n){return b.$and(n)},$or:function(n){return n.map(y)},$nor:function(n){return n.map(y)},$not:function(n){return y(n)},$regex:function(n,t){return new RegExp(n,t.$options)},$where:function(n){return"string"==typeof n?new Function("obj","return "+n):n},$elemMatch:function(n){return y(n)},$exists:function(n){return!!n}};v.use=function(n){if(e(n))return n(v);for(var t in n)36===t.charCodeAt(0)&&(g[t]=n[t])},v.indexOf=function(n,t,e){return f(t,p(n,e))},v.compare=function(n,t){if(n===t)return 0;if(typeof n==typeof t){if(n>t)return 1;if(n<t)return-1}},Object.defineProperty(t,"__esModule",{value:!0}),n.exports=v,t.default=n.exports.default=v,"undefined"!=typeof window&&(window.sift=v)}()})),l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},h=function(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")},d=function(){function n(n,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}(),y=function(){function n(n,t){var e=[],r=!0,o=!1,i=void 0;try{for(var u,c=n[Symbol.iterator]();!(r=(u=c.next()).done)&&(e.push(u.value),!t||e.length!==t);r=!0);}catch(n){o=!0,i=n}finally{try{!r&&c.return&&c.return()}finally{if(o)throw i}}return e}return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return n(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),p=function(){function n(t){h(this,n),this.conditions=t.conditions,this.actions=t.actions,this.subject=t.subject,this.inverted=!!t.inverted,this._matches=this.conditions?s(this.conditions):null}return d(n,[{key:"matches",value:function(n){return!this._matches||this._matches(n)}}]),n}(),v={manage:["create","read","update","delete"]},g="undefined"!=typeof Symbol?Symbol.for("private"):"__private"+Date.now(),b=function(){function n(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.RuleType,o=void 0===r?p:r,i=e.subjectName,u=void 0===i?c:i;h(this,n),this[g]={RuleType:o,subjectName:u,originalRules:t,rules:{},aliases:f(v)},this.update(t)}return d(n,null,[{key:"addAlias",value:function(n,t){return v[n]=t,this}}]),d(n,[{key:"update",value:function(n){return Array.isArray(n)&&(this[g].originalRules=Object.freeze(n.slice(0)),this[g].rules=this.buildIndexFor(this.rules)),this}},{key:"buildIndexFor",value:function(n){for(var t={},e=this[g].RuleType,r=0;r<n.length;r++)for(var o=n[r],i=this.expandActions(o.actions),u=0;u<i.length;u++)for(var c=i[u],f=Array.isArray(o.subject)?o.subject:[o.subject],a=0;a<f.length;a++){var s=f[a];t[s]=t[s]||{},t[s][c]=t[s][c]||[],t[s][c].unshift(new e(o))}return t}},{key:"expandActions",value:function(n){var t=this,e=Array.isArray(n)?n:[n],r=this[g].aliases;return e.reduce(function(n,e){return r.hasOwnProperty(e)?n.concat(t.expandActions(r[e])):n},e)}},{key:"can",value:function(n,t){var e=this[g].subjectName(t),r=this.rulesFor(n,e);if(t===e)return r.length>0;for(var o=0;o<r.length;o++)if(r[o].matches(t))return!r[o].inverted;return!1}},{key:"rulesFor",value:function(n,t){var e=this[g].subjectName(t),r=this[g].rules,o=r.hasOwnProperty(e)?r[e][n]:null;return((r.hasOwnProperty("all")?r.all[n]:null)||[]).concat(o||[])}},{key:"cannot",value:function(n,t){return!this.can(n,t)}},{key:"throwUnlessCan",value:function(n,t){if(this.cannot(n,t))throw new u('Cannot execute "'+n+'" on "'+this[g].subjectName(t)+'"')}},{key:"rules",get:function(){return this[g].originalRules}}]),n}(),m=function(){function n(){h(this,n),this.rules=[]}return d(n,null,[{key:"define",value:function(n,t){var e=y("function"==typeof n?[{},n]:[n,t],2),r=e[0],o=e[1],i=new this;return o(i.can.bind(i),i.cannot.bind(i)),new b(i.rules,r)}}]),d(n,[{key:"can",value:function(n,t,e){if(!a(n))throw new TypeError("AbilityBuilder#can expects the first parameter to be an action or array of actions");if(!a(t))throw new TypeError("AbilityBuilder#can expects the second argument to be a subject name or array of subject names");var r={actions:n,subject:t};return"object"===(void 0===e?"undefined":l(e))&&e&&(r.conditions=e),this.rules.push(r),r}},{key:"cannot",value:function(){var n=this.can.apply(this,arguments);return n.inverted=!0,n}}]),n}();n.toMongoQuery=o,n.mongoosePlugin=function(n){return n.query.accessibleBy=i,n.statics.accessibleBy=i,n},n.rulesToQuery=t,n.Ability=b,n.Rule=p,n.AbilityBuilder=m,n.ForbiddenError=u,Object.defineProperty(n,"__esModule",{value:!0})});
