generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Staff {
  id                String                  @id @default(cuid())
  email             String                  @unique
  username          String?                 @unique
  password          String
  firstName         String
  lastName          String
  role              StaffRole               @default(EMPLOYEE)
  department        String?
  position          String?
  phone             String?
  rut               String?
  isActive          Boolean                 @default(true)
  hireDate          DateTime?
  metadata          Json                    @default("{}")
  tenantId          String
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  salary            Decimal?                @db.Decimal(12, 2)
  salaryType        SalaryType              @default(MONTHLY)
  hourlyRate        Decimal?                @db.Decimal(10, 2)
  vacationDaysTotal Int                     @default(15)
  vacationDaysUsed  Int                     @default(0)
  attendances       Attendance[]
  auditLogs         AuditLog[]
  reimbursements    EmployeeReimbursement[]
  expenses          Expense[]
  payrollRuns       PayrollRun[]
  productDelivered  ProductMovement[]       @relation("DeliveredByStaff")
  productReceived   ProductMovement[]       @relation("ReceivedByStaff")
  ptoRequests       PTORequest[]
  shifts            Shift[]
  tenant            Tenant                  @relation(fields: [tenantId], references: [id])
  contactRelations  StaffContact[]
  productsOwned     StaffProduct[]          @relation("StaffOwnsProduct")
  taskAssignments   TaskAssignment[]        @relation("StaffTaskAssignments")
  taskComments      TaskComment[]           @relation("StaffTaskComments")
  tasksCreated      Task[]                  @relation("TaskCreatedBy")
  transactions      Transaction[]           @relation("TransactionCreatedBy")

  @@index([tenantId])
  @@map("staff")
}

model Category {
  id          String         @id @default(cuid())
  name        String
  description String?
  emoji       String         @default("ðŸ“¦")
  color       String         @default("#3B82F6")
  isActive    Boolean        @default(true)
  tenantId    String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  format      ProductFormat?
  tenant      Tenant         @relation(fields: [tenantId], references: [id])

  @@unique([name, tenantId])
  @@index([tenantId])
  @@map("categories")
}

model Product {
  id                     String                  @id @default(cuid())
  sku                    String
  ean                    String?
  name                   String
  description            String?
  type                   ProductType             @default(INPUT)
  category               String?
  brand                  String?
  unitPrice              Decimal                 @db.Decimal(12, 2)
  costPrice              Decimal?                @db.Decimal(12, 2)
  currentStock           Int                     @default(0)
  minStock               Int                     @default(0)
  maxStock               Int?
  unit                   String                  @default("UNIT")
  hasRecipe              Boolean                 @default(false)
  wholesalePrice         Decimal?                @db.Decimal(12, 2)
  retailPrice            Decimal?                @db.Decimal(12, 2)
  menuSection            String?
  hoy                    Boolean                 @default(false)
  cafePrice              Decimal?                @db.Decimal(12, 2)
  rappiPrice             Decimal?                @db.Decimal(12, 2)
  pedidosyaPrice         Decimal?                @db.Decimal(12, 2)
  uberPrice              Decimal?                @db.Decimal(12, 2)
  images                 Json                    @default("[]")
  isActive               Boolean                 @default(true)
  metadata               Json                    @default("{}")
  tenantId               String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  format                 ProductFormat?
  tags                   String[]                @default([])
  sourceUrl              String?
  shortDescription       String?
  ingredientConsumptions IngredientConsumption[] @relation("ConsumedIngredients")
  inventoryRecords       InventoryRecord[]
  modifierGroups         ModifierGroup[]
  movements              ProductMovement[]
  suppliers              ProductSupplier[]
  variants               ProductVariant[]
  tenant                 Tenant                  @relation(fields: [tenantId], references: [id])
  purchaseOrderItems     PurchaseOrderItem[]
  recipesAsIngredient    RecipeIngredient[]      @relation("IngredientInRecipes")
  recipesAsProduct       Recipe[]                @relation("ProductRecipes")
  staffOwners            StaffProduct[]          @relation("ProductOwnedByStaff")
  transactionItems       TransactionItem[]

  @@unique([tenantId, sku])
  @@index([tenantId, type])
  @@index([tenantId, category])
  @@map("products")
}

model ProductVariant {
  id             String   @id @default(cuid())
  productId      String
  name           String
  sku            String?
  sortOrder      Int      @default(0)
  isDefault      Boolean  @default(false)
  isActive       Boolean  @default(true)
  metadata       Json     @default("{}")
  tenantId       String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  cafePrice      Decimal? @db.Decimal(12, 2)
  costPrice      Decimal? @db.Decimal(12, 2)
  description    String?
  displayName    String?
  images         Json     @default("[]")
  maxStock       Int?
  minStock       Int?
  pedidosyaPrice Decimal? @db.Decimal(12, 2)
  rappiPrice     Decimal? @db.Decimal(12, 2)
  uberPrice      Decimal? @db.Decimal(12, 2)
  useCustomName  Boolean  @default(false)
  price          Decimal? @db.Decimal(12, 2)
  sourceUrl      String?
  tags           String[] @default([])
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenant         Tenant   @relation(fields: [tenantId], references: [id])

  @@index([productId])
  @@index([tenantId])
  @@map("product_variants")
}

model ModifierGroup {
  id            String            @id @default(cuid())
  productId     String?
  name          String
  description   String?
  isRequired    Boolean           @default(false)
  allowMultiple Boolean           @default(true)
  minSelections Int               @default(0)
  maxSelections Int?
  sortOrder     Int               @default(0)
  isActive      Boolean           @default(true)
  tenantId      String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  product       Product?          @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenant        Tenant            @relation(fields: [tenantId], references: [id])
  modifiers     ProductModifier[]

  @@index([productId])
  @@index([tenantId])
  @@map("modifier_groups")
}

model ProductModifier {
  id                       String                    @id @default(cuid())
  modifierGroupId          String
  name                     String
  type                     ModifierType              @default(ADD)
  priceAdjustment          Decimal                   @default(0) @db.Decimal(12, 2)
  sortOrder                Int                       @default(0)
  isActive                 Boolean                   @default(true)
  tenantId                 String
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  cafePriceAdjustment      Decimal?                  @db.Decimal(12, 2)
  pedidosyaPriceAdjustment Decimal?                  @db.Decimal(12, 2)
  rappiPriceAdjustment     Decimal?                  @db.Decimal(12, 2)
  uberPriceAdjustment      Decimal?                  @db.Decimal(12, 2)
  modifierGroup            ModifierGroup             @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  tenant                   Tenant                    @relation(fields: [tenantId], references: [id])
  transactionItems         TransactionItemModifier[]

  @@index([modifierGroupId])
  @@index([tenantId])
  @@map("product_modifiers")
}

model ContactTypeConfig {
  id          String               @id @default(cuid())
  name        String
  label       String
  description String?
  icon        String?
  color       String?
  isSystem    Boolean              @default(false)
  isActive    Boolean              @default(true)
  order       Int                  @default(0)
  tenantId    String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  fields      ContactFieldConfig[]
  tenant      Tenant               @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, name])
  @@index([tenantId, isActive])
  @@map("contact_type_configs")
}

model ContactFieldConfig {
  id            String            @id @default(cuid())
  contactTypeId String
  fieldName     String
  fieldLabel    String
  fieldType     String
  isRequired    Boolean           @default(false)
  isVisible     Boolean           @default(true)
  order         Int               @default(0)
  placeholder   String?
  helpText      String?
  validation    Json?
  options       Json?
  defaultValue  String?
  tenantId      String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  contactType   ContactTypeConfig @relation(fields: [contactTypeId], references: [id], onDelete: Cascade)
  tenant        Tenant            @relation(fields: [tenantId], references: [id])

  @@unique([contactTypeId, fieldName])
  @@index([contactTypeId, isVisible])
  @@map("contact_field_configs")
}

model Contact {
  id                String            @id @default(cuid())
  code              String
  name              String
  contactType       String
  rut               String?
  email             String?
  phone             String?
  contactName       String?
  address           String?
  city              String?
  country           String?
  creditLimit       Decimal?          @db.Decimal(12, 2)
  currentDebt       Decimal           @default(0) @db.Decimal(12, 2)
  paymentTerms      String?
  rating            Int?
  isActive          Boolean           @default(true)
  metadata          Json              @default("{}")
  tenantId          String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  tenant            Tenant            @relation(fields: [tenantId], references: [id])
  movements         ProductMovement[]
  products          ProductSupplier[]
  purchaseOrders    PurchaseOrder[]
  staffRelations    StaffContact[]
  salesTransactions Transaction[]     @relation("ContactSales")

  @@unique([tenantId, code])
  @@unique([tenantId, rut])
  @@index([tenantId])
  @@index([tenantId, contactType])
  @@map("contacts")
}

model StaffContact {
  id             String    @id @default(cuid())
  staffId        String
  contactId      String
  relationship   String
  startDate      DateTime  @default(now())
  endDate        DateTime?
  commissionRate Decimal?  @db.Decimal(5, 2)
  notes          String?
  contact        Contact   @relation(fields: [contactId], references: [id])
  staff          Staff     @relation(fields: [staffId], references: [id])

  @@unique([staffId, contactId, relationship])
  @@index([staffId])
  @@index([contactId])
  @@map("staff_contacts")
}

model StaffProduct {
  id           String    @id @default(cuid())
  staffId      String
  productId    String
  relationship String
  startDate    DateTime  @default(now())
  endDate      DateTime?
  permissions  Json      @default("[]")
  notes        String?
  product      Product   @relation("ProductOwnedByStaff", fields: [productId], references: [id])
  staff        Staff     @relation("StaffOwnsProduct", fields: [staffId], references: [id])

  @@unique([staffId, productId, relationship])
  @@index([staffId])
  @@index([productId])
  @@map("staff_products")
}

model ProductSupplier {
  id            String    @id @default(cuid())
  productId     String
  supplierId    String
  supplierSKU   String?
  supplierPrice Decimal   @db.Decimal(12, 2)
  leadTimeDays  Int?
  minOrderQty   Int       @default(1)
  isPreferred   Boolean   @default(false)
  isActive      Boolean   @default(true)
  lastPurchase  DateTime?
  notes         String?
  product       Product   @relation(fields: [productId], references: [id])
  supplier      Contact   @relation(fields: [supplierId], references: [id])

  @@unique([productId, supplierId])
  @@index([productId])
  @@index([supplierId])
  @@map("product_suppliers")
}

model ProductMovement {
  id            String       @id @default(cuid())
  type          MovementType
  productId     String
  quantity      Int
  fromLocation  String?
  toLocation    String?
  supplierId    String?
  receivedById  String?
  deliveredById String?
  referenceType String?
  referenceId   String?
  cost          Decimal?     @db.Decimal(12, 2)
  notes         String?
  metadata      Json         @default("{}")
  tenantId      String
  createdAt     DateTime     @default(now())
  deliveredBy   Staff?       @relation("DeliveredByStaff", fields: [deliveredById], references: [id])
  product       Product      @relation(fields: [productId], references: [id])
  receivedBy    Staff?       @relation("ReceivedByStaff", fields: [receivedById], references: [id])
  supplier      Contact?     @relation(fields: [supplierId], references: [id])
  tenant        Tenant       @relation(fields: [tenantId], references: [id])

  @@index([productId])
  @@index([supplierId])
  @@index([tenantId, createdAt])
  @@map("product_movements")
}

model Transaction {
  id                     String                  @id @default(cuid())
  type                   TransactionType
  status                 TransactionStatus
  contactId              String?
  subtotal               Decimal                 @db.Decimal(12, 2)
  tax                    Decimal                 @db.Decimal(12, 2)
  discount               Decimal                 @default(0) @db.Decimal(12, 2)
  total                  Decimal                 @db.Decimal(12, 2)
  paymentMethod          PaymentMethod?
  paymentStatus          PaymentStatus           @default(PENDING)
  notes                  String?
  metadata               Json                    @default("{}")
  tenantId               String
  createdById            String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  ingredientConsumptions IngredientConsumption[]
  taxDocuments           TaxDocument[]
  items                  TransactionItem[]
  contact                Contact?                @relation("ContactSales", fields: [contactId], references: [id])
  createdBy              Staff?                  @relation("TransactionCreatedBy", fields: [createdById], references: [id])
  tenant                 Tenant                  @relation(fields: [tenantId], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([contactId])
  @@map("transactions")
}

model TransactionItem {
  id            String                    @id @default(cuid())
  transactionId String
  productId     String?
  productName   String
  quantity      Int
  unitPrice     Decimal                   @db.Decimal(12, 2)
  discount      Decimal                   @default(0) @db.Decimal(12, 2)
  totalPrice    Decimal                   @db.Decimal(12, 2)
  variantId     String?
  variantName   String?
  modifiers     TransactionItemModifier[]
  product       Product?                  @relation(fields: [productId], references: [id])
  transaction   Transaction               @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_items")
}

model TransactionItemModifier {
  id                String          @id @default(cuid())
  transactionItemId String
  modifierId        String
  modifierName      String
  modifierType      ModifierType
  priceAdjustment   Decimal         @db.Decimal(12, 2)
  createdAt         DateTime        @default(now())
  modifier          ProductModifier @relation(fields: [modifierId], references: [id])
  transactionItem   TransactionItem @relation(fields: [transactionItemId], references: [id], onDelete: Cascade)

  @@index([transactionItemId])
  @@map("transaction_item_modifiers")
}

model PurchaseOrder {
  id           String              @id @default(cuid())
  orderNumber  String
  supplierId   String
  status       PurchaseStatus
  orderDate    DateTime            @default(now())
  expectedDate DateTime?
  receivedDate DateTime?
  subtotal     Decimal             @db.Decimal(12, 2)
  tax          Decimal             @db.Decimal(12, 2)
  shipping     Decimal             @default(0) @db.Decimal(12, 2)
  total        Decimal             @db.Decimal(12, 2)
  notes        String?
  metadata     Json                @default("{}")
  tenantId     String
  createdById  String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  items        PurchaseOrderItem[]
  supplier     Contact             @relation(fields: [supplierId], references: [id])
  tenant       Tenant              @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, orderNumber])
  @@index([supplierId])
  @@index([tenantId, status])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  productId       String?
  productName     String
  quantity        Int
  unitPrice       Decimal       @db.Decimal(12, 2)
  totalPrice      Decimal       @db.Decimal(12, 2)
  receivedQty     Int           @default(0)
  product         Product?      @relation(fields: [productId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("purchase_order_items")
}

model Recipe {
  id                String             @id @default(cuid())
  productId         String
  name              String
  description       String?
  servingSize       Int                @default(1)
  prepTime          Int?
  cookTime          Int?
  difficulty        RecipeDifficulty   @default(EASY)
  instructions      String?
  estimatedCost     Decimal?           @db.Decimal(12, 2)
  laborCost         Decimal?           @db.Decimal(12, 2)
  overheadCost      Decimal?           @db.Decimal(12, 2)
  totalCost         Decimal?           @db.Decimal(12, 2)
  version           Int                @default(1)
  isActive          Boolean            @default(true)
  isDefault         Boolean            @default(false)
  tenantId          String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  productionBatches ProductionBatch[]
  ingredients       RecipeIngredient[]
  product           Product            @relation("ProductRecipes", fields: [productId], references: [id], onDelete: Cascade)
  tenant            Tenant             @relation(fields: [tenantId], references: [id])

  @@index([productId])
  @@index([tenantId, isActive])
  @@map("recipes")
}

model RecipeIngredient {
  id           String   @id @default(cuid())
  recipeId     String
  ingredientId String
  quantity     Decimal  @db.Decimal(12, 4)
  unit         String
  isOptional   Boolean  @default(false)
  notes        String?
  unitCost     Decimal? @db.Decimal(12, 2)
  totalCost    Decimal? @db.Decimal(12, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ingredient   Product  @relation("IngredientInRecipes", fields: [ingredientId], references: [id])
  recipe       Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([ingredientId])
  @@map("recipe_ingredients")
}

model ProductionBatch {
  id              String           @id @default(cuid())
  batchNumber     String
  recipeId        String
  productId       String
  plannedQuantity Int
  actualQuantity  Int?
  status          ProductionStatus @default(PLANNED)
  startedAt       DateTime?
  completedAt     DateTime?
  ingredientCost  Decimal?         @db.Decimal(12, 2)
  laborCost       Decimal?         @db.Decimal(12, 2)
  overheadCost    Decimal?         @db.Decimal(12, 2)
  totalCost       Decimal?         @db.Decimal(12, 2)
  costPerUnit     Decimal?         @db.Decimal(12, 2)
  notes           String?
  tenantId        String
  createdById     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  recipe          Recipe           @relation(fields: [recipeId], references: [id])
  tenant          Tenant           @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, batchNumber])
  @@index([tenantId, status])
  @@map("production_batches")
}

model IngredientConsumption {
  id            String       @id @default(cuid())
  transactionId String?
  productId     String
  recipeId      String
  ingredientId  String
  quantityUsed  Decimal      @db.Decimal(12, 4)
  unit          String
  cost          Decimal?     @db.Decimal(12, 2)
  consumedAt    DateTime     @default(now())
  tenantId      String
  ingredient    Product      @relation("ConsumedIngredients", fields: [ingredientId], references: [id])
  tenant        Tenant       @relation(fields: [tenantId], references: [id])
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([productId])
  @@index([ingredientId])
  @@index([tenantId, consumedAt])
  @@map("ingredient_consumptions")
}

model InventoryRecord {
  id            String    @id @default(cuid())
  productId     String
  location      String
  quantity      Int
  reservedQty   Int       @default(0)
  availableQty  Int
  lastCountDate DateTime?
  notes         String?
  tenantId      String
  updatedAt     DateTime  @updatedAt
  product       Product   @relation(fields: [productId], references: [id])
  tenant        Tenant    @relation(fields: [tenantId], references: [id])

  @@unique([productId, location, tenantId])
  @@map("inventory_records")
}

model TaxDocument {
  id            String            @id @default(cuid())
  type          TaxDocumentType
  folio         String?
  documentCode  Int?
  transactionId String?
  emitterRUT    String?
  emitterName   String?
  receiverRUT   String?
  receiverName  String?
  netAmount     Decimal?          @db.Decimal(12, 2)
  taxAmount     Decimal?          @db.Decimal(12, 2)
  totalAmount   Decimal?          @db.Decimal(12, 2)
  currency      String            @default("CLP")
  issuedAt      DateTime?
  status        TaxDocumentStatus @default(DRAFT)
  pdfUrl        String?
  xmlUrl        String?
  rawResponse   Json?
  tenantId      String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  expenses      Expense[]
  items         TaxDocumentItem[]
  tenant        Tenant            @relation(fields: [tenantId], references: [id])
  transaction   Transaction?      @relation(fields: [transactionId], references: [id])

  @@unique([emitterRUT, folio, tenantId])
  @@index([tenantId, status])
  @@map("tax_documents")
}

model TaxDocumentItem {
  id            String      @id @default(cuid())
  taxDocumentId String
  productName   String
  quantity      Int
  unitPrice     Decimal     @db.Decimal(12, 2)
  totalPrice    Decimal     @db.Decimal(12, 2)
  taxDocument   TaxDocument @relation(fields: [taxDocumentId], references: [id], onDelete: Cascade)

  @@map("tax_document_items")
}

model PaymentAccount {
  id             String                  @id @default(cuid())
  name           String
  type           AccountType
  accountNumber  String?
  bank           String?
  currency       String                  @default("CLP")
  balance        Decimal?                @db.Decimal(12, 2)
  isActive       Boolean                 @default(true)
  tenantId       String
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  reimbursements EmployeeReimbursement[]
  expenses       Expense[]
  tenant         Tenant                  @relation(fields: [tenantId], references: [id])

  @@map("payment_accounts")
}

model EmployeeReimbursement {
  id               String              @id @default(cuid())
  staffId          String
  description      String
  totalAmount      Decimal             @db.Decimal(12, 2)
  currency         String              @default("CLP")
  status           ReimbursementStatus @default(PENDING)
  paidDate         DateTime?
  paidAmount       Decimal?            @db.Decimal(12, 2)
  paymentAccountId String?
  paymentReference String?
  notes            String?
  tenantId         String
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  paymentAccount   PaymentAccount?     @relation(fields: [paymentAccountId], references: [id])
  staff            Staff               @relation(fields: [staffId], references: [id])
  tenant           Tenant              @relation(fields: [tenantId], references: [id])
  expenses         Expense[]

  @@map("employee_reimbursements")
}

model ExpenseCategory {
  id          String         @id @default(cuid())
  name        String
  emoji       String?
  description String?
  color       String         @default("#64748B")
  isActive    Boolean        @default(true)
  tenantId    String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  format      ProductFormat?
  tenant      Tenant         @relation(fields: [tenantId], references: [id])
  expenses    Expense[]

  @@map("expense_categories")
}

model ExpenseStatus {
  id        String    @id @default(cuid())
  name      String
  color     String    @default("#64748B")
  isDefault Boolean   @default(false)
  tenantId  String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  expenses  Expense[]

  @@map("expense_statuses")
}

model Expense {
  id                  String                 @id @default(cuid())
  date                DateTime
  supplier            String
  description         String
  amount              Decimal                @db.Decimal(12, 2)
  currency            String                 @default("CLP")
  documentType        String
  documentNumber      String?
  thirdPartyDocType   String?
  thirdPartyDocNumber String?
  notes               String?
  paymentType         ExpensePaymentType
  paymentAccountId    String?
  staffId             String?
  reimbursementId     String?
  isCompanyExpense    Boolean                @default(true)
  excludeFromReports  Boolean                @default(false)
  isFromInvoice       Boolean                @default(false)
  taxDocumentId       String?
  receiptImageUrl     String?
  receiptPublicId     String?
  hasReceipt          Boolean                @default(false)
  categoryId          String
  statusId            String
  tenantId            String
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  category            ExpenseCategory        @relation(fields: [categoryId], references: [id])
  paymentAccount      PaymentAccount?        @relation(fields: [paymentAccountId], references: [id])
  reimbursement       EmployeeReimbursement? @relation(fields: [reimbursementId], references: [id])
  staff               Staff?                 @relation(fields: [staffId], references: [id])
  status              ExpenseStatus          @relation(fields: [statusId], references: [id])
  taxDocument         TaxDocument?           @relation(fields: [taxDocumentId], references: [id])
  tenant              Tenant                 @relation(fields: [tenantId], references: [id])

  @@map("expenses")
}

model Tenant {
  id                     String                  @id @default(cuid())
  name                   String
  slug                   String                  @unique
  rut                    String?
  address                String?
  phone                  String?
  email                  String?
  domain                 String?
  settings               Json                    @default("{}")
  features               Json                    @default("[]")
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  apiKeys                ApiKey[]
  attendances            Attendance[]
  categories             Category[]
  contactFieldConfigs    ContactFieldConfig[]
  contactTypeConfigs     ContactTypeConfig[]
  contacts               Contact[]
  employeeReimbursements EmployeeReimbursement[]
  expenseCategories      ExpenseCategory[]
  expenseStatuses        ExpenseStatus[]
  expenses               Expense[]
  ingredientConsumptions IngredientConsumption[]
  inventory              InventoryRecord[]
  modifierGroups         ModifierGroup[]
  paymentAccounts        PaymentAccount[]
  payrollRuns            PayrollRun[]
  productModifiers       ProductModifier[]
  movements              ProductMovement[]
  productVariants        ProductVariant[]
  productionBatches      ProductionBatch[]
  products               Product[]
  ptoRequests            PTORequest[]
  purchaseOrders         PurchaseOrder[]
  recipes                Recipe[]
  shifts                 Shift[]
  staff                  Staff[]
  tasks                  Task[]
  taxDocuments           TaxDocument[]
  transactions           Transaction[]

  @@map("tenants")
}

model AuditLog {
  id        String   @id @default(cuid())
  staffId   String?
  action    String
  entity    String
  entityId  String?
  oldData   Json?
  newData   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  staff     Staff?   @relation(fields: [staffId], references: [id])

  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Shift {
  id           String       @id @default(cuid())
  name         String
  startTime    DateTime
  endTime      DateTime
  dayOfWeek    Int?
  isRecurring  Boolean      @default(false)
  specificDate DateTime?
  staffId      String
  tenantId     String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  attendances  Attendance[]
  staff        Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id])

  @@index([tenantId, staffId])
  @@index([specificDate])
  @@map("shifts")
}

model Attendance {
  id             String           @id @default(cuid())
  shiftId        String
  staffId        String
  date           DateTime
  scheduledStart DateTime
  scheduledEnd   DateTime
  actualCheckIn  DateTime?
  actualCheckOut DateTime?
  status         AttendanceStatus
  minutesLate    Int?
  totalHours     Decimal?         @db.Decimal(5, 2)
  notes          String?
  tenantId       String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  shift          Shift            @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  staff          Staff            @relation(fields: [staffId], references: [id], onDelete: Cascade)
  tenant         Tenant           @relation(fields: [tenantId], references: [id])

  @@unique([shiftId, date])
  @@index([tenantId, staffId, date])
  @@index([date])
  @@map("attendances")
}

model PayrollRun {
  id          String        @id @default(cuid())
  periodStart DateTime
  periodEnd   DateTime
  staffId     String
  hoursWorked Decimal       @db.Decimal(8, 2)
  regularPay  Decimal       @db.Decimal(12, 2)
  overtimePay Decimal?      @db.Decimal(12, 2)
  deductions  Decimal?      @db.Decimal(12, 2)
  totalPay    Decimal       @db.Decimal(12, 2)
  netPay      Decimal       @db.Decimal(12, 2)
  status      PayrollStatus @default(PENDING)
  paidAt      DateTime?
  notes       String?
  tenantId    String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  staff       Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)
  tenant      Tenant        @relation(fields: [tenantId], references: [id])

  @@index([tenantId, staffId])
  @@index([periodStart, periodEnd])
  @@map("payroll_runs")
}

model PTORequest {
  id          String    @id @default(cuid())
  staffId     String
  startDate   DateTime
  endDate     DateTime
  days        Int
  reason      String?
  status      PTOStatus @default(PENDING)
  requestedAt DateTime  @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?
  tenantId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  staff       Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  @@index([tenantId, staffId])
  @@index([status])
  @@map("pto_requests")
}

model Task {
  id                  String           @id @default(cuid())
  title               String
  description         String?
  status              TaskStatus       @default(TODO)
  priority            Priority         @default(MEDIUM)
  dueDate             DateTime?
  completedAt         DateTime?
  googleChatSpaceId   String?
  googleChatMessageId String?
  
  // Google Tasks API Integration
  googleTaskId        String?          // Google Tasks API identifier
  googleTasksListId   String?          // Parent task list (usually from Chat space)
  googleTasksUpdatedAt DateTime?       // Track Google's last modified timestamp
  syncStatus          SyncStatus       @default(PENDING) // PENDING, SYNCED, CONFLICT, ERROR
  syncDirection       SyncDirection    @default(BIDIRECTIONAL) // TO_GOOGLE, FROM_GOOGLE, BIDIRECTIONAL
  lastSyncAt          DateTime?        // When was the last sync performed
  
  tenantId            String
  createdById         String
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  assignments         TaskAssignment[]
  comments            TaskComment[]
  createdBy           Staff            @relation("TaskCreatedBy", fields: [createdById], references: [id])
  tenant              Tenant           @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([dueDate])
  @@index([createdById])
  @@index([googleTaskId])
  @@index([syncStatus])
  @@map("tasks")
}

model TaskAssignment {
  id         String         @id @default(cuid())
  taskId     String
  staffId    String
  role       AssignmentRole @default(ASSIGNEE)
  assignedAt DateTime       @default(now())
  assignedBy String
  staff      Staff          @relation("StaffTaskAssignments", fields: [staffId], references: [id])
  task       Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, staffId])
  @@index([staffId])
  @@map("task_assignments")
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  staffId   String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staff     Staff    @relation("StaffTaskComments", fields: [staffId], references: [id])
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([staffId])
  @@map("task_comments")
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  key         String    @unique
  tenantId    String
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdById String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([key, isActive])
  @@map("api_keys")
}

enum ModifierType {
  ADD
  REMOVE
}

enum StaffRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  SUPERVISOR
  EMPLOYEE
  CONTRACTOR
  INTERN
}

enum SyncStatus {
  PENDING
  SYNCED
  CONFLICT
  ERROR
}

enum SyncDirection {
  TO_GOOGLE
  FROM_GOOGLE
  BIDIRECTIONAL
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AssignmentRole {
  ASSIGNEE
  REVIEWER
  OBSERVER
}

enum MovementType {
  PURCHASE
  SALE
  TRANSFER
  ADJUSTMENT
  RETURN
  DAMAGE
  PRODUCTION
  PRODUCTION_INPUT
  PRODUCTION_OUTPUT
  SALE_CONSUMPTION
}

enum TransactionType {
  SALE
  REFUND
  EXCHANGE
  QUOTE
}

enum TransactionStatus {
  DRAFT
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  TRANSFER
  CHECK
  CREDIT
  OTHER
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  REFUNDED
}

enum PurchaseStatus {
  DRAFT
  ORDERED
  PARTIAL_RECEIVED
  RECEIVED
  CANCELLED
}

enum TaxDocumentType {
  BOLETA
  FACTURA
  NOTA_CREDITO
  NOTA_DEBITO
  GUIA_DESPACHO
}

enum TaxDocumentStatus {
  DRAFT
  ISSUED
  CANCELLED
  REJECTED
}

enum AccountType {
  BANK_ACCOUNT
  CREDIT_CARD
  DEBIT_CARD
  CASH
  DIGITAL_WALLET
  OTHER
}

enum ReimbursementStatus {
  PENDING
  APPROVED
  PAID
  PARTIALLY_PAID
  REJECTED
  CANCELLED
}

enum ExpensePaymentType {
  COMPANY_ACCOUNT
  EMPLOYEE_PAID
  PERSONAL
  MIXED
}

enum ProductType {
  INPUT
  READY_PRODUCT
  MANUFACTURED
  MADE_TO_ORDER
  SERVICE
}

enum ProductFormat {
  PACKAGED
  FROZEN
  FRESH
}

enum ProductionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RecipeDifficulty {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum SalaryType {
  HOURLY
  MONTHLY
}

enum AttendanceStatus {
  ON_TIME
  LATE
  ABSENT
  EARLY_DEPARTURE
  APPROVED_PTO
}

enum PayrollStatus {
  PENDING
  APPROVED
  PAID
}

enum PTOStatus {
  PENDING
  APPROVED
  DENIED
}
